import * as fs from "fs";
import {
  fromHex,
  MsgInstantiateContractResponse,
  MsgStoreCodeResponse,
  SecretNetworkClient,
  toBase64,
  Wallet,
} from "secretjs";

export async function sleep(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

export async function waitForBlocks(chainId: string) {
  const secretjs = new SecretNetworkClient({
    url: "http://localhost:1317",
    chainId,
  });

  console.log(`Waiting for blocks on ${chainId}...`);
  while (true) {
    try {
      const { block } = await secretjs.query.tendermint.getLatestBlock({});

      if (Number(block?.header?.height) >= 1) {
        console.log(`Current block on ${chainId}: ${block!.header!.height}`);
        break;
      }
    } catch (e) {}
    await sleep(100);
  }
}

type Account = {
  address: string;
  mnemonic: string;
  wallet: Wallet;
  secretjs: SecretNetworkClient;
};

const accounts: Account[] = [];

let code_id: string;

beforeAll(async () => {
  jest.spyOn(console, "warn").mockImplementation(() => {});

  const mnemonics = [
    "grant rice replace explain federal release fix clever romance raise often wild taxi quarter soccer fiber love must tape steak together observe swap guitar",
    "jelly shadow frog dirt dragon use armed praise universe win jungle close inmate rain oil canvas beauty pioneer chef soccer icon dizzy thunder meadow",
    "chair love bleak wonder skirt permit say assist aunt credit roast size obtain minute throw sand usual age smart exact enough room shadow charge",
    "word twist toast cloth movie predict advance crumble escape whale sail such angry muffin balcony keen move employ cook valve hurt glimpse breeze brick",
  ];

  // Create clients for all of the existing wallets in secretdev-1
  for (let i = 0; i < mnemonics.length; i++) {
    const mnemonic = mnemonics[i];
    const wallet = new Wallet(mnemonic);
    accounts.push({
      address: wallet.address,
      mnemonic: mnemonic,
      wallet: wallet,
      secretjs: new SecretNetworkClient({
        url: "http://localhost:1317",
        wallet: wallet,
        walletAddress: wallet.address,
        chainId: "secretdev-1",
      }),
    });
  }

  await waitForBlocks("secretdev-1");

  const wasmBytes = fs.readFileSync(
    `${__dirname}/../contract.wasm`
  ) as Uint8Array;

  console.log("Storing contract on-chain...");

  const { secretjs } = accounts[0];

  let tx = await secretjs.tx.compute.storeCode(
    {
      sender: secretjs.address,
      wasm_byte_code: wasmBytes,
      source: "",
      builder: "",
    },
    { gasLimit: 2_000_000 }
  );

  if (tx.code !== 0) {
    console.log(tx.rawLog);
  }
  expect(tx.code).toBe(0);

  ({ code_id } = MsgStoreCodeResponse.decode(tx.data[0]));
}, 90_000);

test("gm", async () => {
  const { secretjs } = accounts[0];

  let tx = await secretjs.tx.compute.instantiateContract(
    {
      sender: secretjs.address,
      code_id,
      init_msg: {
        encryption_key: toBase64(
          fromHex(
            "69020000000000003233363737333033393834313239313538333233353439303031373431303836323737393335303436323738353138353231323032363734393931363134373739303837323334303632323735343630303335383737353838333034333530353731353433383832343035373537353031353336393430353531313335333030393030333431383732363639393636353637333131303534393838303233343636363631353934343230313834363231343633313833393534383938353035383138313030313938383836383531333532343033373434383136343538343833383335363235383139323039323432353131393031373036393931363034393138373231383837393833323530313135323339373739303533393131363835363339323132353333363533353636333938373635303635343937373131323933383539393732323737363639353932373936343837303631363135383537373339323330363232343931393933313239353834393437373638363136383034393236323039333336333134383733353337353830343630373838303939373536323035363933373931393635383234353036373632393838333531313833383736383031393739303230303936323937373431353135353237313136373436393536383631393033323132383531323639313938363439333138373833363634323032373334303139323737303639383534343536373933323935353639353037373035323038363737363037313636323230343430363937343531343539353335303332353738323334323337393035343139303539363930323536373834343834393936343537"
          )
        ),
      },
      label: String(Date.now()),
    },
    { gasLimit: 1_000_000 }
  );

  if (tx.code !== 0) {
    console.log(tx.rawLog);
  }
  expect(tx.code).toBe(0);

  const contract_address = MsgInstantiateContractResponse.decode(
    tx.data[0]
  ).address;

  tx = await secretjs.tx.compute.executeContract(
    {
      sender: secretjs.address,
      contract_address,
      msg: {
        c1: toBase64(
          fromHex(
            "d00400000000000035303932373637393330393837353434353437333239333035353030373238353331383430383633383233393033303239393437393939333935353335323337393839313534393334383832313835343638303837363431353236393530343831363038323032373532333833333134303538393038383432323936323139303634333530303631333536323530353731353234393430353032353637353837363336353439353238343735343330353136373639353137343232333837373532353837373536343836383730393633303837353137383838333738363039353839343135363732333931333532363832353038373938303932373237383134323231383931363834353831313433363338343635323431323033303036363031333537343536383136313733303636323338343932343235383231363036323837303936323838383739323539333935353139313639323131323938323531313839333034363037303535323033303537383135373037343933363136313937353338393134323632363630393735363337333232303036383738353837373432363032333130363736303436323538373636323833373938303537303732373634393235363632343834383035343736393231323330393937333333333930353739393133333833373839303038363836323630333837313833333635343932313937373830303931393737383533313136333534333930373633353438313738333330313832323330393430383734383238343831383430313032343636323932323835313938313239363639323538373136303332313339363835333435383135303130353935343732303731363832303333313333383436323531393234353733383734353738363533333939313436383033333838343738353431323437303034313739363230353732313638393631313033353435303133343236383034333131303035303138323237313434323634323733313635373339303530353438383032373337353138303732313031333132333239363830303034303039353332373438363939353237303238313131333132363138323135343734363239323630343839333739353731353735383036313232363436353137303332383638323831343937393439323439333830343532373834333037343832353934383136313837333835393236333431313830323137393337383332313533363937363837343938333830313736353533383835383031323532383630343432363239383534313135313034353733323635333933323835393836353333393139363332323633373239353839373938353536393935383632383531373936393537323734373637353239363137313638383736333531373538343033323334313831353731353633303630363633323339333336393835353337363038313734363634373935393830343238323633363439303733343837393132383237303137393831303937393235383531363732313131393538343336333536363635303635323837313736363532333539323830393736303935373535393930323133373734303836313333313231303138393539323934323135313833313633353431343038353835393135393439373839393835313138373637393638303634383433303835333530323834370100000000000000"
          )
        ),
        c2: toBase64(
          fromHex(
            "d1040000000000003234353336303438393539323833353334313137303732323432333732333738313439373837323532353535333637323533353735323630373437303038323137313031313130323736303637393937393632353137343736363731343231343336313035393637333438373633303035343235313233393236353539323432383631333734333335353232333230363736393130393333353534313330333935303535303636343139303337323837363936383938343931343938383633393232373631363738303634313235353435363539333131383531333937303235373938383936353738343634383732313832303839373638393339353639333034343433383831373232303330303233323631353939303533303737393638303234393933363236393632343530343737353637363233343131393233393733393839363138313530303432383430323136383735343839383137373034333839373537393334383132313638363335373839313637393433363530363537303730333933363536323230353438393232333735323935363637343131303638363835313733383034313338333037343131373536353633353335343936363932373935323237333031333538353339313033353036303338353138363139363939303839393536353231393533333534383237313638393932383930393130353939323930313434303833303933323739383437303133353339333636363930323436383335383031303532323030373430333330393839373739313436353539393533353137343035363530313330313834323337343334343735393532333030353134303439303738393437353438323037353834373533363438373633303435353234333231373438363737303738373437343937383439343236303435353236303137323335323934343233393139313937303334343734323435343834343135363138373231383237383237383632393937323337353436353133383739373737323332373138373933383234333735333736353930343237323034333639343437393632383734333634393238343537343930333931383736383030393838373939353234313538303537383630393830313130353833363539313734313139333238373639393037333836303136363431393836303230383233353235363034303731313530343539383234333539353035373135373131393134353936383733363734363239313132363232303739323331343832353330353835383738373130393936353033303930353738353035343731323037323931353231333839343237333635323036363337313430333139323339343735383936313034363339383333373931343939303033303937303034383032343136393036393031313633363830393137353032303734383935323032383937333637363436353733353537333935313138363938343139323034383432393233353632323333353837393430383637383438303334353139303033323134343139323232383531353438333939353732383332383036383732303338313633303230313335393739353534323935373339313038323933313431303135323631383734323137343337343739353730323232373734373636373933393532393433343732323834343835323637333130380100000000000000"
          )
        ),
      },
    },
    { gasLimit: 1_000_000 }
  );

  if (tx.code !== 0) {
    console.log(tx.rawLog);
  }
  expect(tx.code).toBe(0);

  console.log("Add gas:", tx.gasUsed);
});
